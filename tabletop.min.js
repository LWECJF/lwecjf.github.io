(function(){var k=!1;if("undefined"!==typeof process&&!process.browser)var k=!0,p=require("request".trim());var f=!1,l=!1;try{"undefined"!==typeof(new XMLHttpRequest).withCredentials?f=!0:"XDomainRequest"in window&&(l=f=!0)}catch(a){}var n=Array.prototype.indexOf,m=function(a,b){var c=0,d=a.length;if(n&&a.indexOf===n)return a.indexOf(b);for(;c<d;c++)if(a[c]===b)return c;return-1},e=function(a){if(!(this&&this instanceof e))return new e(a);"string"===typeof a&&(a={key:a});this.callback=a.callback;
this.wanted=a.wanted||[];this.key=a.key;this.simpleSheet=!!a.simpleSheet;this.parseNumbers=!!a.parseNumbers;this.wait=!!a.wait;this.reverse=!!a.reverse;this.postProcess=a.postProcess;this.debug=!!a.debug;this.query=a.query||"";this.orderby=a.orderby;this.endpoint=a.endpoint||"https://spreadsheets.google.com";this.singleton=!!a.singleton;this.simple_url=!!a.simple_url;this.callbackContext=a.callbackContext;this.prettyColumnNames="undefined"==typeof a.prettyColumnNames?!a.proxy:a.prettyColumnNames;
"undefined"!==typeof a.proxy&&(this.endpoint=a.proxy.replace(/\/$/,""),this.singleton=this.simple_url=!0,f=!1);this.parameterize=a.parameterize||!1;this.singleton&&("undefined"!==typeof e.singleton&&this.log("WARNING! Tabletop singleton already defined"),e.singleton=this);/key=/.test(this.key)&&(this.log("You passed an old Google Docs url as the key! Attempting to parse."),this.key=this.key.match("key=(.*?)(&|#|$)")[1]);/pubhtml/.test(this.key)&&(this.log("You passed a new Google Spreadsheets url as the key! Attempting to parse."),
this.key=this.key.match("d\\/(.*?)\\/pubhtml")[1]);this.key?(this.log("Initializing with key "+this.key),this.models={},this.model_names=[],this.base_json_path="/feeds/worksheets/"+this.key+"/public/basic?alt=",this.base_json_path=k||f?this.base_json_path+"json":this.base_json_path+"json-in-script",this.wait||this.fetch()):this.log("You need to pass Tabletop a key!")};e.callbacks={};e.init=function(a){return new e(a)};e.sheets=function(){this.log("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")};
e.prototype={fetch:function(a){"undefined"!==typeof a&&(this.callback=a);this.requestData(this.base_json_path,this.loadSheets)},requestData:function(a,b){if(k)this.serverSideFetch(a,b);else{var c=this.endpoint.split("//").shift()||"http";!f||l&&c!==location.protocol?this.injectScript(a,b):this.xhrFetch(a,b)}},xhrFetch:function(a,b){var c=l?new XDomainRequest:new XMLHttpRequest;c.open("GET",this.endpoint+a);var d=this;c.onload=function(){try{var a=JSON.parse(c.responseText)}catch(e){console.error(e)}b.call(d,
a)};c.send()},injectScript:function(a,b){var c=document.createElement("script"),d;if(this.singleton)b===this.loadSheets?d="Tabletop.singleton.loadSheets":b===this.loadSheet&&(d="Tabletop.singleton.loadSheet");else{var g=this;d="tt"+ +new Date+Math.floor(1E5*Math.random());e.callbacks[d]=function(){var a=Array.prototype.slice.call(arguments,0);b.apply(g,a);c.parentNode.removeChild(c);delete e.callbacks[d]};d="Tabletop.callbacks."+d}var q=a+"&callback="+d;this.simple_url?-1!==a.indexOf("/list/")?c.src=
this.endpoint+"/"+this.key+"-"+a.split("/")[4]:c.src=this.endpoint+"/"+this.key:c.src=this.endpoint+q;this.parameterize&&(c.src=this.parameterize+encodeURIComponent(c.src));document.getElementsByTagName("script")[0].parentNode.appendChild(c)},serverSideFetch:function(a,b){var c=this;p({url:this.endpoint+a,json:!0},function(a,g,e){if(a)return console.error(a);b.call(c,e)})},isWanted:function(a){return 0===this.wanted.length?!0:-1!==m(this.wanted,a)},data:function(){if(0!==this.model_names.length)return this.simpleSheet?
(1<this.model_names.length&&this.debug&&this.log("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong."),this.models[this.model_names[0]].all()):this.models},addWanted:function(a){-1===m(this.wanted,a)&&this.wanted.push(a)},loadSheets:function(a){var b,c,d=[];this.googleSheetName=a.feed.title.$t;this.foundSheetNames=[];b=0;for(c=a.feed.entry.length;b<c;b++)if(this.foundSheetNames.push(a.feed.entry[b].title.$t),this.isWanted(a.feed.entry[b].content.$t)){var g=
a.feed.entry[b].link[a.feed.entry[b].link.length-1].href.split("/").pop(),g="/feeds/list/"+this.key+"/"+g+"/public/values?alt=",g=k||f?g+"json":g+"json-in-script";this.query&&(g+="&sq="+this.query);this.orderby&&(g+="&orderby=column:"+this.orderby.toLowerCase());this.reverse&&(g+="&reverse=true");d.push(g)}this.sheetsToLoad=d.length;b=0;for(c=d.length;b<c;b++)this.requestData(d[b],this.loadSheet)},sheets:function(a){if("undefined"===typeof a)return this.models;if("undefined"!==typeof this.models[a])return this.models[a]},
sheetReady:function(a){this.models[a.name]=a;-1===m(this.model_names,a.name)&&this.model_names.push(a.name);this.sheetsToLoad--;0===this.sheetsToLoad&&this.doCallback()},loadSheet:function(a){var b=this;new e.Model({data:a,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this,prettyColumnNames:this.prettyColumnNames,onReady:function(){b.sheetReady(this)}})},doCallback:function(){0===this.sheetsToLoad&&this.callback.apply(this.callbackContext||this,[this.data(),this])},log:function(a){this.debug&&
"undefined"!==typeof console&&"undefined"!==typeof console.log&&Function.prototype.apply.apply(console.log,[console,arguments])}};e.Model=function(a){var b,c,d,g;this.column_names=[];this.name=a.data.feed.title.$t;this.tabletop=a.tabletop;this.elements=[];this.onReady=a.onReady;this.raw=a.data;if("undefined"===typeof a.data.feed.entry)a.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers"),this.original_columns=[],this.elements=[],this.onReady.call(this);else{for(b in a.data.feed.entry[0])/^gsx/.test(b)&&
this.column_names.push(b.replace("gsx$",""));this.original_columns=this.column_names;b=0;for(d=a.data.feed.entry.length;b<d;b++){var e=a.data.feed.entry[b],h={};c=0;for(g=this.column_names.length;c<g;c++){var f=e["gsx$"+this.column_names[c]];"undefined"!==typeof f?a.parseNumbers&&""!==f.$t&&!isNaN(f.$t)?h[this.column_names[c]]=+f.$t:h[this.column_names[c]]=f.$t:h[this.column_names[c]]=""}void 0===h.rowNumber&&(h.rowNumber=b+1);a.postProcess&&a.postProcess(h);this.elements.push(h)}a.prettyColumnNames?
this.fetchPrettyColumns():this.onReady.call(this)}};e.Model.prototype={all:function(){return this.elements},fetchPrettyColumns:function(){if(!this.raw.feed.link[3])return this.ready();var a=this.raw.feed.link[3].href.replace("/feeds/list/","/feeds/cells/").replace("https://spreadsheets.google.com",""),b=this;this.tabletop.requestData(a,function(a){b.loadPrettyColumns(a)})},ready:function(){this.onReady.call(this)},loadPrettyColumns:function(a){for(var b={},c=this.column_names,d=0,e=c.length;d<e;d++)b[c[d]]=
"undefined"!==typeof a.feed.entry[d].content.$t?a.feed.entry[d].content.$t:c[d];this.pretty_columns=b;this.prettifyElements();this.ready()},prettifyElements:function(){var a=[],b=[],c,d,e,f;d=0;for(f=this.column_names.length;d<f;d++)b.push(this.pretty_columns[this.column_names[d]]);c=0;for(e=this.elements.length;c<e;c++){var h={};d=0;for(f=this.column_names.length;d<f;d++)h[this.pretty_columns[this.column_names[d]]]=this.elements[c][this.column_names[d]];a.push(h)}this.elements=a;this.column_names=
b},toArray:function(){var a=[],b,c,d,e;b=0;for(d=this.elements.length;b<d;b++){var f=[];c=0;for(e=this.column_names.length;c<e;c++)f.push(this.elements[b][this.column_names[c]]);a.push(f)}return a}};"undefined"!==typeof module&&module.exports?module.exports=e:"function"===typeof define&&define.amd?define(function(){return e}):window.Tabletop=e})();
